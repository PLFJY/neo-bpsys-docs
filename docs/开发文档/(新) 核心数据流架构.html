<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>NeoBpSys 核心数据流架构 | neo-bpsys Docs </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="NeoBpSys 核心数据流架构 | neo-bpsys Docs ">
      
      
      <link rel="icon" href="../../images/favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="../toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/PLFJY/neo-bpsys-docs/blob/master/docs/开发文档/(新) 核心数据流架构.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../images/favicon.ico" alt="neo-bpsys-wpf">
            neo-bpsys-wpf
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="neobpsys-核心数据流架构">NeoBpSys 核心数据流架构</h1>

<h2 id="整体架构概览">整体架构概览</h2>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                     NeoBpSys.Core (跨平台)                                  │
│                                                                                           │
│  ┌─────────────┐     ┌──────────┐     ┌─────────────┐     ┌──────────────┐     ┌───────┐  │
│  │   Models    │────▶│  Enums   │────▶│ ValueTypes  │────▶│  Interfaces  │────▶│ Events│  │
│  └─────────────┘     └──────────┘     └─────────────┘     └──────────────┘     └───────┘  │
│         │                                                                 ▲               │
│         │                                                                 │               │
│         ▼                                                                 │               │
│  ┌─────────────────────┐                                                  │               │
│  │  Core Business Logic│◀─────────────────────────────────────────────────┘               │
│  └─────────────────────┘                                                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
                         ▲                                  │
                         │                                  │
                         │                                  ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                  NeoBpSys (WPF 主项目)                                      │
│                                                                                           │
│  ┌─────────────┐     ┌──────────────┐     ┌─────────────┐     ┌───────────────────┐       │
│  │  ViewModels │────▶│     Views    │────▶│ Converters  │────▶│   UI Controls     │       │
│  └─────────────┘     └──────────────┘     └─────────────┘     └───────────────────┘       │
│         ▲                                                                             │
│         │                                                                             │
│         └─────────────────────────────────────────────────────────────────────────────┘
└─────────────────────────────────────────────────────────────────────────────────────────────┘
                         ▲
                         │
                         │
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                  插件系统 (Plugin)                                          │
│                                                                                           │
│  ┌─────────────┐     ┌───────────────────┐                                                │
│  │   Plugins   │────▶│ ISharedDataService│─────────────────────────────────────────────────▶│
│  └─────────────┘     └───────────────────┘                                                │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h2 id="详细数据流流程">详细数据流流程</h2>
<h3 id="1-数据结构定义core-项目">1. 数据结构定义（.Core 项目）</h3>
<pre><code class="lang-mermaid">flowchart TD
    A[.Core 项目] --&gt; B[核心模型]
    A --&gt; C[枚举类型]
    A --&gt; D[值类型]
    
    B --&gt; B1[Character.cs]
    B --&gt; B2[Game.cs]
    B --&gt; B3[Team.cs]
    B --&gt; B4[Member.cs]
    B --&gt; B5[Player.cs]
    
    D --&gt; D1[Color.cs - 跨平台颜色]
    
    B1 --&gt; B11[&quot;partial class Character : ObservableObject&quot;]
    B11 --&gt; B111[&quot;[ObservableProperty] private string _name;&quot;]
    B11 --&gt; B112[&quot;[ObservableProperty] private Color _backgroundColor;&quot;]
    B11 --&gt; B113[&quot;[ObservableProperty] private ObservableCollection&lt;Talent&gt; _talents;&quot;]
</code></pre>
<h3 id="2-数据变更流程">2. 数据变更流程</h3>
<pre><code class="lang-mermaid">flowchart TD
    A[数据变更源] --&gt;|插件或主程序| B[SharedDataService]
    B --&gt;|调用方法| C[Core 模型]
    
    subgraph .Core
        C --&gt; C1[&quot;Character character = GetCharacterById(id);&quot;]
        C1 --&gt; C2[&quot;character.Name = 'New Name';&quot;]
        C2 --&gt; C3[&quot;触发 PropertyChanged(nameof(Name))&quot;]
    end
    
    C3 --&gt;|对象引用变化| D{是否对象引用变化?}
    D --&gt;|是| E[&quot;触发外层属性 PropertyChanged&quot;]
    D --&gt;|否| F[&quot;WPF 自动处理内部属性变更&quot;]
    
    E --&gt; G[TeamInfoPageViewModel.CurrentGame]
    F --&gt; H[MapV2Presenter.xaml 绑定]
    
    G --&gt; I[Converter 转换]
    H --&gt; I
    
    subgraph WPF
        I --&gt; I1[&quot;ColorToBrushConverter.Convert()&quot;]
        I1 --&gt; I2[&quot;System.Windows.Media.Brush&quot;]
        I2 --&gt; J[UI 更新]
    end
</code></pre>
<h3 id="3-完整数据变更到ui更新流程">3. 完整数据变更到UI更新流程</h3>
<pre><code class="lang-mermaid">sequenceDiagram
    participant Plugin as 插件
    participant SharedData as SharedDataService
    participant CoreModel as Core 模型
    participant ViewModel as TeamInfoPageViewModel
    participant WPF as WPF 绑定系统
    participant Converter as ColorToBrushConverter
    participant UI as UI 元素
    
    Plugin-&gt;&gt;SharedData: AssignCharacterToMember(memberId, characterId)
    SharedData-&gt;&gt;CoreModel: member.Character = newCharacter
    CoreModel-&gt;&gt;CoreModel: 触发 PropertyChanged(nameof(Character))
    
    alt 对象引用变化
        CoreModel-&gt;&gt;ViewModel: CurrentGame 属性变更
        ViewModel-&gt;&gt;ViewModel: OnPropertyChanged(nameof(CurrentGame))
        ViewModel-&gt;&gt;WPF: WPF 检测到 CurrentGame 变更
        WPF-&gt;&gt;WPF: 重新解析绑定路径
        WPF-&gt;&gt;WPF: 检测到 Players[0].Member.Character 变化
        WPF-&gt;&gt;Converter: 转换 Character.BackgroundColor
        Converter-&gt;&gt;Converter: Color -&gt; SolidColorBrush
        Converter-&gt;&gt;UI: 返回 SolidColorBrush
        UI-&gt;&gt;UI: 更新 UI 元素
    else 内部属性变化
        CoreModel-&gt;&gt;WPF: 检测到 Character.Name 变更
        WPF-&gt;&gt;WPF: 自动更新绑定到 Name 的 UI 元素
    end
</code></pre>
<h2 id="具体实现步骤">具体实现步骤</h2>
<h3 id="1-core-项目结构">1. .Core 项目结构</h3>
<pre><code>NeoBpSys.Core/
├─ Entities/
│   ├─ Character/
│   │   ├─ Character.cs       // 保留ObservableObject
│   │   ├─ Talent.cs          // 保留ObservableObject
│   │   └─ ...
│   ├─ Game/
│   │   ├─ Game.cs            // 保留ObservableObject
│   │   ├─ Player.cs          // 保留ObservableObject
│   │   ├─ Score.cs           // 保留ObservableObject
│   │   └─ ...
│   └─ Teams/
│       ├─ Team.cs            // 保留ObservableObject
│       ├─ Member.cs          // 保留ObservableObject
│       └─ ...
├─ Enums/
│   ├─ BanListName.cs
│   ├─ Camp.cs
│   ├─ GameAction.cs
│   └─ ...  // 从您项目中的Enums迁移
├─ ValueTypes/
│   └─ Color.cs               // 跨平台Color实现
└─ Services/
    └─ ISharedDataService.cs  // 仅定义接口
</code></pre>
<h3 id="2-数据流关键点说明">2. 数据流关键点说明</h3>
<h4 id="a-对象引用变化处理如更换character">a) 对象引用变化处理（如更换Character）</h4>
<pre><code class="lang-csharp">// SharedDataService.cs
public void AssignCharacterToMember(Guid memberId, Guid characterId)
{
    var member = GetMemberById(memberId);
    var oldCharacter = member.Character;
    var newCharacter = GetCharacterById(characterId);
    
    if (oldCharacter != newCharacter)
    {
        member.Character = newCharacter;
        // 触发Member.Character的PropertyChanged
        // WPF会自动更新绑定到Member.Character的所有UI
    }
}
</code></pre>
<pre><code class="lang-csharp">// TeamInfoPageViewModel.cs
// 不需要特殊处理 - WPF会自动更新{Binding Players[0].Member.Character.Name}
</code></pre>
<h4 id="b-对象替换处理如更换currentgame">b) 对象替换处理（如更换CurrentGame）</h4>
<pre><code class="lang-csharp">// SharedDataService.cs
private Game _currentGame;
public event EventHandler CurrentGameChanged;

public Game CurrentGame
{
    get =&gt; _currentGame;
    set
    {
        if (_currentGame != value)
        {
            _currentGame = value;
            CurrentGameChanged?.Invoke(this, EventArgs.Empty);
        }
    }
}

public void StartNewGame()
{
    CurrentGame = new Game(); // 会触发CurrentGameChanged
}
</code></pre>
<pre><code class="lang-csharp">// TeamInfoPageViewModel.cs
public TeamInfoPageViewModel(ISharedDataService sharedData)
{
    _sharedData = sharedData;
    _sharedData.CurrentGameChanged += (s, e) =&gt; 
        OnPropertyChanged(nameof(CurrentGame));
}

public Game CurrentGame =&gt; _sharedData.CurrentGame;
</code></pre>
<pre><code class="lang-xaml">&lt;!-- TeamInfoPage.xaml --&gt;
&lt;TextBlock Text=&quot;{Binding CurrentGame.Players[0].Member.Character.Name}&quot;/&gt;
&lt;!-- 当CurrentGame对象被替换时，会重新解析整个绑定路径 --&gt;
</code></pre>
<h4 id="c-跨平台color处理">c) 跨平台Color处理</h4>
<pre><code class="lang-csharp">// .Core/ValueTypes/Color.cs
public readonly struct Color
{
    public byte R { get; }
    public byte G { get; }
    public byte B { get; }
    public byte A { get; }
    
    public Color(byte r, byte g, byte b, byte a = 255)
    {
        R = r;
        G = g;
        B = b;
        A = a;
    }
    
    // 常用颜色
    public static Color Red =&gt; new Color(255, 0, 0);
    // ...
}
</code></pre>
<pre><code class="lang-csharp">// .Core/Entities/Character/Character.cs
public partial class Character : ObservableObject
{
    [ObservableProperty]
    private Color _backgroundColor;  // 使用跨平台Color
}
</code></pre>
<pre><code class="lang-csharp">// 主项目/Converters/ColorToBrushConverter.cs
public class ColorToBrushConverter : IValueConverter
{
    public object Convert(object value, Type targetType, 
        object parameter, CultureInfo culture)
    {
        if (value is Color coreColor)
        {
            return new SolidColorBrush(
                System.Windows.Media.Color.FromArgb(
                    coreColor.A, coreColor.R, coreColor.G, coreColor.B));
        }
        return Brushes.Transparent;
    }
    
    // ConvertBack 实现...
}
</code></pre>
<pre><code class="lang-xaml">&lt;!-- TeamInfoPage.xaml --&gt;
&lt;Border Background=&quot;{Binding CurrentGame.Players[0].Member.Character.BackgroundColor, 
                    Converter={StaticResource ColorToBrushConverter}}&quot;/&gt;
</code></pre>
<h3 id="3-message系统迁移路径">3. Message系统迁移路径</h3>
<table>
<thead>
<tr>
<th>旧Message</th>
<th>新机制</th>
<th>迁移步骤</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NewGameMessage</code></td>
<td><code>SharedDataService.CurrentGameChanged</code></td>
<td>1. 在SharedDataService中添加CurrentGameChanged事件<br>2. 将Messenger.Send替换为SharedDataService.StartNewGame()</td>
</tr>
<tr>
<td><code>CharacterSwappedMessage</code></td>
<td><code>Member.Character</code> PropertyChanged</td>
<td>1. 移除Message发送<br>2. 确保Character属性正确触发PropertyChanged</td>
</tr>
<tr>
<td><code>MemberPropertyChangedMessage</code></td>
<td>直接属性变更</td>
<td>1. 移除Message发送<br>2. 直接修改属性，依赖自动通知</td>
</tr>
<tr>
<td><code>PlayerSwappedMessage</code></td>
<td><code>Game.Players</code> 集合变更</td>
<td>1. 确保Players是ObservableCollection<br>2. 使用集合操作方法</td>
</tr>
</tbody>
</table>
<h2 id="优势">优势</h2>
<ol>
<li><p><strong>符合WPF设计哲学</strong>：</p>
<ul>
<li>充分利用WPF内置的绑定机制</li>
<li>避免了不必要的抽象层</li>
<li>与您现有的深层绑定兼容</li>
</ul>
</li>
<li><p><strong>解决&quot;屎山&quot;问题</strong>：</p>
<ul>
<li>淘汰了9种Message类型</li>
<li>建立了清晰的数据中枢（SharedDataService）</li>
<li>修复了&quot;缺乏层级性&quot;和&quot;中心缺失&quot;问题</li>
</ul>
</li>
<li><p><strong>跨平台支持</strong>：</p>
<ul>
<li>.Core可被WPF、Avalonia、Blazor等使用</li>
<li>通过Converter处理平台特定类型</li>
<li>保持核心模型的纯净性</li>
</ul>
</li>
<li><p><strong>插件系统友好</strong>：</p>
<ul>
<li>插件只需引用.Core</li>
<li>通过SharedDataService接口操作数据</li>
<li>无需了解UI实现细节</li>
</ul>
</li>
</ol>
<h2 id="迁移实施路线图">迁移实施路线图</h2>
<ol>
<li><p><strong>阶段1：创建.Core项目</strong></p>
<ul>
<li>迁移Models目录到.Core</li>
<li>创建跨平台Color类型</li>
<li>确保所有模型保持ObservableObject实现</li>
<li>保证去除WPF特有特征</li>
</ul>
</li>
<li><p><strong>阶段2：重构SharedDataService</strong></p>
<ul>
<li>添加对象替换事件（如CurrentGameChanged）</li>
<li>替换Message发送为直接数据操作</li>
<li>移除不必要的Message处理</li>
</ul>
</li>
<li><p><strong>阶段3：更新Converter</strong></p>
<ul>
<li>实现Color到Brush的转换</li>
<li>处理其他跨平台类型转换</li>
</ul>
</li>
<li><p><strong>阶段4：淘汰Message系统</strong></p>
<ul>
<li>从NewGameMessage开始</li>
<li>逐步替换所有Message类型</li>
<li>验证UI更新是否正常工作</li>
</ul>
</li>
</ol>
<p>.Core保持纯净但包含INotifyPropertyChanged，UI层通过Converter处理平台特定类型，利用WPF的内置机制处理数据绑定，同时为插件系统提供清晰的接口。整个方案无需额外的包装ViewModel，充分利用了WPF绑定机制。</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/PLFJY/neo-bpsys-docs/blob/master/docs/开发文档/(新) 核心数据流架构.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
